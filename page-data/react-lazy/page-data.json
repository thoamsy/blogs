{"componentChunkName":"component---src-templates-blog-post-js","path":"/react-lazy/","result":{"data":{"site":{"siteMetadata":{"title":"ğŸ˜","author":"Yang Kui"}},"markdownRemark":{"id":"0f92a326-3dba-5f9b-85d5-79857a1f1462","html":"<p><strong>NOTE: 8 æœˆ 15 å·é‡å†™äº†å†…å®¹ï¼Œä¹‹å‰çš„æè¿°æœ‰ç‚¹å¤ªè¿·ï¼Œå®Œå…¨æ²¡æœ‰é€»è¾‘æ€§</strong></p>\n<p>ä»¥ä¸‹åˆ†æåŸºäº 16.8</p>\n<p><code class=\"language-text\">React Lazy</code> çš„å®ç°å…¶å®æ˜¯å†…éƒ¨ç»´æŠ¤æ˜¯ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œæ‹¥æœ‰å››ç§çŠ¶æ€ï¼Œåˆ†åˆ«å¯¹åº” Promise çš„ã€‚å®ƒä»¬æ˜¯ä¸€ä¸ª enumï¼Œä» 0-2 åˆ†åˆ«å¯¹åº”ï¼š\n<code class=\"language-text\">0: Pending</code>\n<code class=\"language-text\">1: Resolved</code>\n<code class=\"language-text\">2: Rejected</code></p>\n<p>æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ React é’ˆå¯¹æ™®é€š Component å’Œ Lazy Component ä¸Šå®ç°çš„åŒºåˆ«ï¼šå°±æ˜¯å¦‚ä½• resolve Componentã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">case</span> ClassComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> Component <span class=\"token operator\">=</span> failedUnitOfWork<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isLegacyContextProvider</span><span class=\"token punctuation\">(</span>Component<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">popLegacyContext</span><span class=\"token punctuation\">(</span>failedUnitOfWork<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">case</span> ClassComponentLazy<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> Component <span class=\"token operator\">=</span> <span class=\"token function\">getResultFromResolvedThenable</span><span class=\"token punctuation\">(</span>failedUnitOfWork<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isLegacyContextProvider</span><span class=\"token punctuation\">(</span>Component<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">popLegacyContext</span><span class=\"token punctuation\">(</span>failedUnitOfWork<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ClassComponent å¯ä»¥ç›´æ¥é€šè¿‡ type è¿™ä¸ªå­—æ®µæ‹¿åˆ°ï¼Œè¿™ä¸ªå­—æ®µå…¶å®å°±æ˜¯ React Element è¢«åˆ›å»ºæ—¶ï¼Œ<code class=\"language-text\">&lt;A /&gt;</code> é‡Œçš„è¿™ä¸ª Aã€‚è€Œ lazy ä¸­çš„ <code class=\"language-text\">getResultFromResolvedThenable</code> å°±æ˜¯è¯»å–è¿™ä¸ªå‚æ•°çš„ <code class=\"language-text\">_reactResult</code> å¯¹è±¡ã€‚</p>\n<p>è€Œ <code class=\"language-text\">getResultFromResolvedThenable</code> å…¶å®å®ç°ååˆ†ç®€å•ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">getResultFromResolvedThenable</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">thenable</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> thenable<span class=\"token punctuation\">.</span>_reactResult<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>å› ä¸ºå¯ä»¥ç¡®è®¤è¿™é‡Œçš„ thenable å°±æ˜¯ lazy çš„è¿”å›å€¼ï¼Œæ‰€ä»¥ <code class=\"language-text\">_reactResult</code> åº”è¯¥æ˜¯åœ¨å®ç°çš„æ—¶å€™ï¼Œè¢«æ’è¿›çš„ä¸€ä¸ªå˜é‡ã€‚è¿™é‡ŒåŒ…å«äº† Component å‡½æ•°ã€‚</p>\n<p>æ¥ä¸‹æ¥æˆ‘ä»¬æœç´¢ <code class=\"language-text\">_reactResult</code> å‡ºç°åœ¨å“ªä¸ªåœ°æ–¹ï¼Œæ‰¾äº†ä¸‹é¢ä»£ç ã€‚å®ƒå®ç°äº†å¦‚ä½•å°† lazy ç»„ä»¶ resolve æˆæœ€ç»ˆ Componentã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> readLazyComponentType<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>thenable<span class=\"token punctuation\">:</span> Thenable<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">T</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> status <span class=\"token operator\">=</span> thenable<span class=\"token punctuation\">.</span>_reactStatus<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> Resolved<span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">const</span> Component<span class=\"token punctuation\">:</span> <span class=\"token constant\">T</span> <span class=\"token operator\">=</span> thenable<span class=\"token punctuation\">.</span>_reactResult<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> Component<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> Rejected<span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">throw</span> thenable<span class=\"token punctuation\">.</span>_reactResult<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> Pending<span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">throw</span> thenable<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      thenable<span class=\"token punctuation\">.</span>_reactStatus <span class=\"token operator\">=</span> Pending<span class=\"token punctuation\">;</span>\n      thenable<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>\n        <span class=\"token parameter\">resolvedValue</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>thenable<span class=\"token punctuation\">.</span>_reactStatus <span class=\"token operator\">===</span> Pending<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            thenable<span class=\"token punctuation\">.</span>_reactStatus <span class=\"token operator\">=</span> Resolved<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> resolvedValue <span class=\"token operator\">===</span> <span class=\"token string\">'object'</span> <span class=\"token operator\">&amp;&amp;</span> resolvedValue <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token comment\">// If the `default` property is not empty, assume it's the result</span>\n              <span class=\"token comment\">// of an async import() and use that. Otherwise, use the</span>\n              <span class=\"token comment\">// resolved value itself.</span>\n              <span class=\"token keyword\">const</span> defaultExport <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>resolvedValue<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>default<span class=\"token punctuation\">;</span>\n              resolvedValue <span class=\"token operator\">=</span> defaultExport <span class=\"token operator\">?</span><span class=\"token operator\">?</span> resolvedValue<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n              resolvedValue <span class=\"token operator\">=</span> resolvedValue<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            thenable<span class=\"token punctuation\">.</span>_reactResult <span class=\"token operator\">=</span> resolvedValue<span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>thenable<span class=\"token punctuation\">.</span>_reactStatus <span class=\"token operator\">===</span> Pending<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            thenable<span class=\"token punctuation\">.</span>_reactStatus <span class=\"token operator\">=</span> Rejected<span class=\"token punctuation\">;</span>\n            thenable<span class=\"token punctuation\">.</span>_reactResult <span class=\"token operator\">=</span> error<span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">throw</span> thenable<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ä»£ç ä¸­å‡ºç°äº† 3 æ¬¡ throwã€‚åˆ†åˆ«å‡ºç°åœ¨äº† <code class=\"language-text\">Rejected, Pending, Default</code> ä¸‰ä¸ª case é‡Œã€‚æˆ‘ä»¬å…ˆå…³æ³¨ default çš„é€»è¾‘ï¼Œé‡Œé¢ä¼šçŒœæµ‹ resolve çš„å€¼æ˜¯å¦å«æœ‰ defaultï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œè¯´æ˜å¯èƒ½æ˜¯ async import çš„è¿”å›å€¼ï¼Œé‚£ä¹ˆå°±ç›´æ¥å°† default ç»™ resolve å‡ºæ¥ï¼Œå¦åˆ™è¿”å›è‡ªèº«ã€‚æ¥ç€å°±ä¼šæŠŠå®ƒå†™å…¥åˆ° <code class=\"language-text\">_reactResult</code> ä¸­ã€‚</p>\n<p>é‚£ä¹ˆä¸ºä»€ä¹ˆè¿™äº›åœ°æ–¹éƒ½è¦ throw å®ƒå‘¢ï¼Ÿè¿™é‡Œå°±æ˜¯ Suspense çš„é€»è¾‘äº†ï¼ŒSuspense ä¼š catch ç»„è¢« throw å‡ºæ¥çš„ errorï¼Œå¦‚æœå®ƒæ˜¯ä¸€ä¸ª Promise çš„è¯ï¼Œå°±ä¼šå°† children éƒ½æ¸²æŸ“æˆ fallback çš„å€¼ï¼Œä¸€æ—¦ Promise è¢« resolve åˆ™ä¼šç»§ç»­æ¸²æŸ“ä¸€æ¬¡ï¼Œå¹¶å¾—åˆ°æœ€ç»ˆçš„ç»“æœã€‚\næ‰€ä»¥è¿™é‡Œ default å’Œ Pending éƒ½æ˜¯é’ˆå¯¹ Suspense çš„åœºæ™¯ã€‚è€Œ Rejected å°±æ²¡å•¥å¥½è¯´äº†ï¼Œå‡ºäº†å¼‚å¸¸å½“ç„¶è¦æŠ›å‡ºå»ã€‚</p>\n<p>æœ€åçœ‹ä¸€ä¸‹ React.lazy çš„å®ç°ã€‚å®ƒæ”¾å›çš„å°±æ˜¯ä¸€ä¸ª thenable å¯¹è±¡ï¼Œå­—æ®µå’Œä¸Šé¢çš„å¤„ç†é€»è¾‘æ˜¯ä¸€è‡´çš„ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> lazy<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">R</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token function-variable function\">ctor</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Thenable<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">R</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> thenable <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>thenable <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Lazily create thenable by wrapping in an extra thenable.</span>\n        thenable <span class=\"token operator\">=</span> <span class=\"token function\">ctor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        ctor <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">return</span> thenable<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// React uses these fields to store the result.</span>\n    _reactStatus<span class=\"token punctuation\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    _reactResult<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>å› ä¸º status é»˜è®¤å€¼æ˜¯ -1 ä¹Ÿå°±ä¼šè¿›å…¥ ğŸ‘† çš„ default é€»è¾‘ï¼Œè¿è¡Œ ctorï¼Œå¼€å§‹å°è¯•è§£æ lazy ä¸­çš„ç»„ä»¶ã€‚è¿™ä¹Ÿå°±æ˜¯ lazy çš„å®ç°åŸç†ã€‚</p>","frontmatter":{"title":"React Lazy çš„å®ç°åŸç†","spoiler":"ç®€å•è®¨è®ºä¸€ä¸‹ React.lazy å†…éƒ¨å®ç°","date":"2018/12/23"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/react-lazy/","previous":{"fields":{"slug":"/browser/"},"frontmatter":{"title":"Inside look at modern web browserï¼ˆç¿»è¯‘ï¼‰","spoiler":"è°·æ­Œæ¬ç –"}},"next":{"fields":{"slug":"/react-trap/"},"frontmatter":{"title":"ä¸€äº› React ä¸­çš„åˆé’»é—®é¢˜","spoiler":"æ”¶é›†ä¸€äº›ä¸ä¸ºäººæ‰€çŸ¥çš„ï¼ŒReact çš„ç»†èŠ‚é—®é¢˜ã€‚å¸®åŠ©è‡ªå·±ç†é¡º React å†…éƒ¨æ·±å±‚çš„é€»è¾‘"}}}}}