{"data":{"site":{"siteMetadata":{"title":"ğŸ˜","author":"Yang Kui"}},"markdownRemark":{"id":"0f92a326-3dba-5f9b-85d5-79857a1f1462","html":"<p>å®ç° <code class=\"language-text\">React Lazy</code> å…¶å®æ˜¯å†…éƒ¨ç»´æŠ¤æ˜¯ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œæ‹¥æœ‰å››ç§çŠ¶æ€ï¼Œåˆ†åˆ«å¯¹åº” Promiseï¼š</p>\n<ol>\n<li>Pending</li>\n<li>Resolved</li>\n<li>Rejected</li>\n<li>Default</li>\n</ol>\n<p>å¯ä»¥ç®€å•çš„é€šè¿‡æºç æ¥åˆ†æ</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> readLazyComponentType<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>thenable<span class=\"token punctuation\">:</span> Thenable<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">T</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> status <span class=\"token operator\">=</span> thenable<span class=\"token punctuation\">.</span>_reactStatus<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> Resolved<span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">const</span> Component<span class=\"token punctuation\">:</span> <span class=\"token constant\">T</span> <span class=\"token operator\">=</span> thenable<span class=\"token punctuation\">.</span>_reactResult<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> Component<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> Rejected<span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">throw</span> thenable<span class=\"token punctuation\">.</span>_reactResult<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> Pending<span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">throw</span> thenable<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      thenable<span class=\"token punctuation\">.</span>_reactStatus <span class=\"token operator\">=</span> Pending<span class=\"token punctuation\">;</span>\n      thenable<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>\n        resolvedValue <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>thenable<span class=\"token punctuation\">.</span>_reactStatus <span class=\"token operator\">===</span> Pending<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            thenable<span class=\"token punctuation\">.</span>_reactStatus <span class=\"token operator\">=</span> Resolved<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> resolvedValue <span class=\"token operator\">===</span> <span class=\"token string\">'object'</span> <span class=\"token operator\">&amp;&amp;</span> resolvedValue <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token comment\">// If the `default` property is not empty, assume it's the result</span>\n              <span class=\"token comment\">// of an async import() and use that. Otherwise, use the</span>\n              <span class=\"token comment\">// resolved value itself.</span>\n              <span class=\"token keyword\">const</span> defaultExport <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>resolvedValue<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">default</span><span class=\"token punctuation\">;</span>\n              resolvedValue <span class=\"token operator\">=</span> defaultExport <span class=\"token operator\">?</span><span class=\"token operator\">?</span> resolvedValue<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n              resolvedValue <span class=\"token operator\">=</span> resolvedValue<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            thenable<span class=\"token punctuation\">.</span>_reactResult <span class=\"token operator\">=</span> resolvedValue<span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        error <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>thenable<span class=\"token punctuation\">.</span>_reactStatus <span class=\"token operator\">===</span> Pending<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            thenable<span class=\"token punctuation\">.</span>_reactStatus <span class=\"token operator\">=</span> Rejected<span class=\"token punctuation\">;</span>\n            thenable<span class=\"token punctuation\">.</span>_reactResult <span class=\"token operator\">=</span> error<span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">throw</span> thenable<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>éœ€è¦æ³¨æ„è¿™é‡Œçš„åœ¨ Pending å’Œ default çŠ¶æ€ä¸‹ä¸ºä»€ä¹ˆéƒ½æ˜¯ throwã€‚å› ä¸º React ä¸ºäº†å®ç° Suspenseï¼Œæ˜¯é€šè¿‡ throw ä¸€ä¸ª Promise åï¼Œåœ¨ React çš„ commit Work ä¸­æœ‰ä¸€ä¸ª <code class=\"language-text\">try catch</code> æ“ä½œæ¥å¤„ç†å®ƒï¼Œå¹¶è¿›å…¥ Suspense çš„æµç¨‹ã€‚</p>\n<p>åŒæ ·çš„ï¼Œåœ¨ä¸€ä¸ª React ä¸­ä½¿ç”¨åˆ°äº† Lazy Component çš„ä»£ç </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">case</span> ClassComponent<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> Component <span class=\"token operator\">=</span> failedUnitOfWork<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isLegacyContextProvider</span><span class=\"token punctuation\">(</span>Component<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">popLegacyContext</span><span class=\"token punctuation\">(</span>failedUnitOfWork<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">case</span> ClassComponentLazy<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> Component <span class=\"token operator\">=</span> <span class=\"token function\">getResultFromResolvedThenable</span><span class=\"token punctuation\">(</span>failedUnitOfWork<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isLegacyContextProvider</span><span class=\"token punctuation\">(</span>Component<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">popLegacyContext</span><span class=\"token punctuation\">(</span>failedUnitOfWork<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>å¯ä»¥çœ‹åˆ°ï¼ŒComponent å’Œ Class Component çš„åŒºåˆ«å°±æ˜¯ type çš„è¯»å–æ–¹å¼ä¸ä¸€æ ·ã€‚è€Œ <code class=\"language-text\">getResultFromResolvedThenable</code> å°±æ˜¯è¯»å–è¿™ä¸ªå‚æ•°çš„ <code class=\"language-text\">_reactResult</code> å¯¹è±¡ã€‚</p>\n<p>è€Œ <code class=\"language-text\">getResultFromResolvedThenable</code> å…¶å®å®ç°ååˆ†ç®€å•ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">getResultFromResolvedThenable</span><span class=\"token punctuation\">(</span>thenable<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> thenable<span class=\"token punctuation\">.</span>_reactResult<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>æœ€åï¼Œ<code class=\"language-text\">React.lazy</code> ä¹Ÿå¾ˆç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚å®ƒä¼šç»´æŠ¤ <code class=\"language-text\">_reactResult</code> ä»¥ç»´æŠ¤æœ€ç»ˆçš„ type(Component)</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> lazy<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">R</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>ctor<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Thenable<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">R</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> thenable <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">then</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>thenable <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Lazily create thenable by wrapping in an extra thenable.</span>\n        thenable <span class=\"token operator\">=</span> <span class=\"token function\">ctor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        ctor <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">return</span> thenable<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// React uses these fields to store the result.</span>\n    _reactStatus<span class=\"token punctuation\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    _reactResult<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>é€šè¿‡è®¾ç½® status ä¸º -1ï¼Œä½¿ React åœ¨å¼€å§‹ read è¿™ä¸ª Lazy Component çš„æ—¶å€™ï¼Œæ‰å¼€å§‹è¿è¡Œ <code class=\"language-text\">ctor</code>ï¼Œåœ¨æˆé•¿åœºæ™¯ä¸‹ <code class=\"language-text\">ctor</code> æ˜¯ä¸€ä¸ªç±»ä¼¼äº <code class=\"language-text\">() =&gt; import(&#39;./src&#39;)</code> çš„è¿”å› Promise çš„å‡½æ•°ã€‚æ‰€ä»¥ React åŸç”Ÿå®ç° lazy load çš„åŸå› æ˜¯ï¼šSuspense é…åˆä¸€ä¸ªå†…éƒ¨å®šä¹‰çš„ <code class=\"language-text\">Thenable</code> å¯¹è±¡ï¼ŒåŒæ—¶è®© Work æ”¯æŒ catch Promiseã€‚</p>","frontmatter":{"title":"React Lazy çš„å®ç°åŸç†","date":"2018/12/23"}}},"pageContext":{"slug":"/react-lazy/","previous":{"fields":{"slug":"/browser/"},"frontmatter":{"title":"Inside look at modern web browserï¼ˆç¿»è¯‘ï¼‰"}},"next":null}}